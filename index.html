<!DOCTYPE html>
<html>
  <head>
    <title>A Whistle-Stop Tour of a Production Frontend Stack | Timecounts.org</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <style type="text/css">

      /* ----- Brand colors ----- */

      .tc-blue { color: #16BECC; }
      .tc-blue-fade { color: #6DD6DF; }
      .tc-navy { color: #2B497F; }
      .tc-navy-fade { color: #7D8FB0; }
      .tc-green { color: #5DC744; }
      .tc-green-fade { color: #9CDBA5; }
      .tc-soft-blue { color: #66ADC7; }
      .tc-soft-blue-fade { color: #A4D0DE; }
      .tc-warm-gray { color: #60545C; }
      .tc-warm-gray-fade { color: #ADA7AB; }
      .tc-light-gray { color: #D8D5D6; }
      .tc-light-gray-fade { color: #EBEAEA; }

      /* ----- Remark overrides ----- */

      .remark-slide-scaler {
        -moz-box-shadow: none;
        -webkit-box-shadow: none;
        box-shadow: none;
      }

      .remark-container,
      .remark-notes-area {
        background: black;
      }

      .remark-slide-content {
        padding: 1em 3em;
      }

      .remark-slide-content h1 {
        font-size: 3.0em;
        line-height: 110%
      }

      .remark-slide-content h2 {
        font-size: 2.5em
      }

      .remark-slide-content.full-code {
        padding: 0
      }

      .full-code pre {
        margin: 0
      }

      .hljs-default .coffeescript .hljs-attribute {
        color: #66ADC7
      }

      .hljs-default .hljs-literal {
        color: #7D8FB0
      }

      .hljs-default .coffeescript .hljs-property {
        color: #6DD6DF
      }

      .hljs-default .hljs,
      .hljs-default .hljs-subst,
      .hljs-default .hljs-tag .hljs-title,
      .hljs-default .nginx .hljs-title {
        color: #9CDBA5
      }


      /* ----- Timecounts styles ----- */

      body {
        font-family: Futura, 'Trebuchet MS', Arial, sans-serif;
      }

      h1, h2, h3, p {
        font-weight: normal;
        color: #60545C;
      }

      p, h3 {
        font-size: 1.8em;
      }

      a {
        color: #16BECC
      }

      strong {
        color: #16BECC
      }

      iframe {
        width: 100%;
        height: 100%;
        border: 2px solid #EBEAEA;
      }

      li, li p {
        font-size: 1.3em;
        line-height: 150%;
        color: #60545C;
      }

      li li {
        font-size: 0.9em
      }

      .aside {
        font-size: 1em;
        color: #60545C
      }

      .title-page-logo {
        width: 100px;
        margin-bottom: 40px;
      }

      .timecounts-is {
        background-image: url('images/volunteers.jpg');
      }

      .typeahead {
        width: 90%;
        display: block;
        margin: 0 auto
      }

      .so-many-files {
        width: 90%;
        display: block;
        margin: 0 auto
      }

      .ctrl-p {
        border: 1px solid white
      }

      .files {
        display: block;
        margin: 0 auto;
        width: 90%
      }

      .devtools {
        display: block;
        margin: 0 auto;
        width: 100%
      }

      .sass-modules {
        display: block;
        margin: 0 auto;
        width: 90%
      }

      .ciw-vim {
        display: block;
        margin: 0 auto;
        width: 90%;
      }

      .double-click-dev-tools {
        display: block;
        margin: 0 auto;
        width: 90%;
        margin-bottom: 1em
      }

      .ship-it {
        display: block;
        margin: 0 auto;
        width: 200px;
        margin-bottom: 1em
      }

      .heroku-review-apps {
        display: block;
        margin: 0 auto;
        width: 90%
      }

      .spec {
        display: block;
        margin: 0 auto;
        width: 100%
      }

      .selenium {
        display: block;
        margin: 0 auto;
        width: 70%
      }

      .servers {
        display: block;
        margin: 0 auto;
        width: 100%
      }


      .sweating {
        background: black url('images/sweating.gif') top left no-repeat;
      }

      .bullet-train {
        background: black url('images/bullet-train.gif') top left no-repeat;
      }

      .full-screen-gif {
        background-size: cover;
      }

      .full-screen-gif h1, .full-screen-gif h2 {
        color: white !important
      }

      /* ----- Template styles ----- */

      .brown {
        background: #6F646C
      }

      .brown h1,
      .brown h2,
      .brown p,
      .brown .remark-inline-code {
        color: white
      }

      .blue {
        background: #26B9C4;
      }

      .blue h1, .blue h2, .blue h3 {
        color: white
      }

      .blue p {
        color: #2B497F;
      }

      .blue a {
        color: white;
      }

      .cover {
        -webkit-background-size: cover !important;
        -moz-background-size: cover !important;
        background-size: cover !important;
        background-position-x: center !important;
        background-position-y: center !important;
        background-repeat: no-repeat !important
      }

      /* ----- Code ----- */

      .has-code {
        background: #101010;
        padding: 0 2em
      }

      .has-code h1, .has-code h2, .has-code h3, .has-code p {
        color: #EBEAEA
      }

      .has-code li {
        color: white
      }

      .has-code .remark-inline-code {
        color: #A4D0DE
      }

      .remark-code, .remark-inline-code {
        font-family: Monaco, "Lucida Console", monospace;
        font-size: 0.8em;
      }

      .remark-inline-code {
        color: #2B497F
      }

      .zoom-code .remark-code {
        font-size: 1.1em;
      }

      .pull-left {
        float: left;
        width: 47%;
      }

      .pull-right {
        float: right;
        width: 47%;
      }

      .comment, .hljs-title {
        color: #969896;
      }

      .hljs-variable, .hljs-attribute, .hljs-tag, .hljs-regexp, .hljs-ruby .constant, .hljs-xml .tag .title, .hljs-xml .pi, .hljs-xml .doctype, .hljs-html .doctype, .hljs-css .id, .hljs-css .class, .hljs-css .pseudo {
        color: #cc6666;
      }

      .hljs-number, .hljs-preprocessor, .hljs-built_in, .hljs-literal, .hljs-params, .hljs-constant {
        color: #de935f;
      }


      .hljs-class, .hljs-ruby .class .title, .hljs-css .rules .attribute {
        color: #f0c674;
      }

      .hljs-string, .hljs-value, .hljs-inheritance, .hljs-header, .hljs-ruby .symbol, .hljs-xml .cdata {
        color: #9CDBA5 !important;
      }

      .hljs-css .hexcolor {
        color: #8abeb7;
      }

      .hljs-function, .hljs-python .decorator, .hljs-python .title, .hljs-ruby .function .title, .hljs-ruby .title .keyword, .hljs-perl .sub, .hljs-javascript .title, .hljs-coffeescript .title {
        color: #81a2be;
      }

      .hljs-keyword, .hljs-javascript .function {
        color: #7D8FB0;
        font-weight: normal !important;
      }

      .hljs-default .hljs {
        background: #101010;
        color: #c5c8c6;
        font-family: Menlo, Monaco, Consolas, monospace;
        line-height: 1.5;
        border: 1px solid #ccc;
        padding: 10px;
      }


      .hljs-default .hljs-tag,
      .hljs-default .xml .hljs-tag,
      .hljs-default .hljs-tag .hljs-title,
      .hljs-default .xml .hljs-tag .hljs-title {
        color: #66ADC7;
        font-weight: normal !important;
      }

      .hljs-default .hljs-title {
        color: #16BECC;
        font-weight: normal !important;
      }

      code, .remark-code {border: none !important}

      .hljs-default .javascript .xml {
        opacity: 1;
      }

      code .lolight,
      code .lolight * {
        color: #666 !important;
      }

      code .hilight,
      code .hilight * {
        color: #5DC744 !important;
      }


    </style>
  </head>
  <body>
    <script id="source" language="remarkjs"><!--


class: title-page, blue
<img src='images/logo-white.png' title='Timecounts Logo' class='title-page-logo' />
# Whistle-stop tour of a frontend stack

Jof Arnold, VP Product and Frontend Dev

Timecounts.org

<div class='backbone-image cover'></div>

---
class: middle, center, blue

### or:

## "How We Learned To Stop Worrying and Love Having Lots Of Files"

---

class: timecounts-is, cover

## Timecounts: a platform for building and managing communities

---

class: middle

# Goals

1. To give new devs an idea of what a production frontend stack might look like

2. Show what&rsquo;s worked and not worked for us

3. Learn from the audience

---

class: middle

# Stuff we'll cover

1. Keeping on top of React code

2. Handling lots of files

3. Keeping on top of styles

4. Build

5. ... and a little bit on testing


---


class: middle

# Follow along

[timecounts.github.io/stack-overview](http://timecounts.github.io/stack-overview)




.aside[
Recommended... lots of detail on some slides
]

---

class: full-screen-gif, bullet-train

## Hold on tight! Much presentation ahead!

---
class: middle, center, brown

#1. Scaling React code

---

class: middle

# React.js key concepts

One-way data flow (`state`, `props`)

Components

.aside[
...and then there's the Virtual DOM, but you can ignore that
]

---

class: middle, has-code

### Components, props & state:
```JS
var Child = React.createClass(
  render: function() {
    <div>
      Is clicked? { this.props.clicked }
    </div>
  }
);

var Parent = React.createClass(
  getInititalState: function() {
    clicked: false
  },
  handleClick: function() {
    this.setState( {clicked: true} )
  },
  render: function() {
    <div>
      <div onClick={ this.handleClick }>Click Me</div>
      <Child clicked={ this.state.clicked } />
    </div>
  }
);
```

---

class: middle, center, blue

## Tip: just use JSX and don't have inline logic

---

class: middle, has-code

## We tried to be clever

```CoffeeScript
{div, p} = React.DOM

MyComponent = React.createClass

  render: ->
    div className: "Foo",
      div className: "SubFoo",
        if @props.flag
          for i in @props.array
            div null, "Count is #{i}"
            break if i > 10
        else
          if @props.other
            div null, "Not counting"

```
We love CoffeeScript, but urgh! So hard to read


---

class: middle, has-code

## Much less ambiguous - if longer
```CoffeeScript

renderIncrements: ->
  nodes = []
  for val, i in this.props.array
    nodes.push <div>Count is { val }</div>
    break if i > 10
  return <div>{ nodes }</div>

renderCount: ->
  if this.props.flag
    return this.renderIncrements()
  else
    return <div>Not counting</div>

render: ->
  <div className="Foo">
    <div className="SubFoo">
      { this.renderCount() }
    </div>
  </div>

```

---
class: middle, center, blue

## Tip: push `this.state` as far up as it can go

---

class: has-code

## Consider a typeahead:

<img src='images/typeahead.png' title='Typeahead' class='typeahead' />

---
class: middlde, has-code

### If you do the following, `Selector` is hard to re-use:

```JS
// Typeahead
handleKeyUp: function() {
  this.refs.selector.moveSelection()
},
getValue: function() {
  return this.refs.selector.getValue()
},
render: function() {
  <div>
    <Input onKeyUp={ this.handleKeyUp } ... blah />
    <Selector ref="selector" ... blah />
  </div>
}

// Selector
moveSelection: function() {
  var newSelectedId = this.state.selectedId + 1;
  this.setState({selectedId: newSelectedId})
}

```

---
class: middle, has-code

### Instead, do this:
```JS
// Typeahead
handleKeyUp: function() {
  var newSelectedId = this.state.selectedId + 1;
  this.setState({selectedId: newSelectedId})
},
getValue: function() {
  return this.state.selectedId
},
render: function() {
  <div>
    <Input onKeyUp={ this.handleKeyUp } ... blah />
    <Selector selectedid={ this.state.selectedId } ... blah />
  </div>
}

// Selector
// ...only renders
```
---

class: middle, center, blue

## Use `propTypes` to define an API


---

class: middle, has-code, zoom-code

## Reduces ambiguity

```JS
propTypes: {
  names: React.PropTypes.arrayOf(React.PropTypes.string),
  people: React.PropTypes.typeOf(SomeCollectionOrSomething),
  isWarning: React.PropTypes.bool,
  fetchData: React.PropTypes.func
}```

(Especially because we often feed components arrays of models as well as collections)

---

class: middle, blue, center

## Use lots and lots of small, dumb components

---

class: middle, has-code, zoom-code
### It's not unusual to have no html elements in a file:

```JSX
render: function() {
  <ModalWrapper>
    <Modal>
      <ModalCore>
        <Title>
          { this.renderTitle() }
        </Title>
        <DelayedSpinner timeout={ 1000 } />
      </ModalCore>
    </Modal>
  </ModalWrapper>
}


```

---

class: middle, center


## Which segues nicely to:

---

class: middle, center, brown

# 2. Files and folders

---

class: middle, blue

### 100s of components, each with its own sass file:

<img src='images/so-many-files.png' title='So Many Files' class='so-many-files' />

---


class: middle, blue

## Wow that's a lot of files!

It's not so bad: we have (unique!) directory-like filenames and use search not file browsers:

<img src='images/ctrl-p.gif' title='ctrp-p' class='ctrl-p' />

---

class: middle

Filenames, component names, classNames all match:


<img src='images/files.png' title='files' class='files' />

---

class: middle

Easy to jump to components/styles from the names/classes in React/Chrome dev tools

<img src='images/devtools.png' title='devtools' class='devtools' />

---

class: middle

### Sounds like a lot of work? Not really:
- Keeping classNames and filenames in sync: `bufdo`/`argdo`/`Rename`
- Finding files amongst the clutter: `grep`/`Ag`/`ctrl-P`
- Boostrapping files: snippets, `ctrl-x` `ctrl-l`

---

class: middle

Besides, how much time do you spend creating versus modifying files?

Benefits >> problems!!!

---

class: middle, center ,blue

## Absolute versus relative paths


---

class: middle, has-code, zoom-code

## Relative paths:

```JS
var React = require('React');

var FooBar = require('../../../FooBar');
var ThingyThing = require('../../ThingyThing');

module.exports = React.createClass(

  render: function(...

```

Can you imagine moving this file? Nightmare!

---

class: middle, has-code, zoom-code

## Absolute paths:

```JS
var React = require('React');

var FooBar = require('components/FooBar');
var ThingyThing = require('components/ThingyThing');

module.exports = React.createClass(

  render: function(...

```

Much nicer!

---

class: middle

## How?

`parallel-transpile` transpiles the CJSX components from `/src` to `/build/node_modules`

More about that later...

---

class: middle

## We don't put extensions in paths


So none of this: `/components/Blah.cjsx`

---

class: middle

## Reasons

So webpack and node can pick the best thing - compiled asset if it exists,
source otherwise

Allows us to change any file to the latest hipster syntax/language whenever
we want without having to rewrite dependants. E.g. moving from `.coffee` to
`.cjsx`


---

class: middle, center, blue

## Sass files

---

class: middle

General sass files are in `sass_modules`

We `@import` them a bit like JS modules

<img src='images/sass-imports.png' title='Sass modules' class='sass-modules' />

---
class: middle

## This means:

- Absolute urls
- Easy line auto-complete
- Tidy files

---
class: middle, has-code, zoom-code

### Add this (or something like it) to your gulp config


```CoffeeScript
includePaths: ['assets/sass_modules/']
```

---

class: middle, center, blue

# Which brings us nicely to:

---

class: middle, center, brown

# 3. Styles


---
class: middle

## CSS is global

The chances of getting accidental overrides is high. Especially with our >9000 selectors!


---

class: middle

# Many solutions

### OOCSS
### BEM
### Radium, PostCSS and a whole bunch of React inline css solutions

---
class: middle, center

### (We chose BEM. For now...)

---


class: middle, has-code, zoom-code

## Our flavour of BEM

### "Conventional":
e.g. `block-name__element-name--modifier-name`

### Us:
`ComponentName_blockName__modifierName`

---

Looks nicer and can double-click in dev tools, editor, etc

.aside[
That said, `ComponentName_blockName--modifier` would be better for vim e.g. `ciw`:
]

<img src='images/ciw.gif' title='ciw vim' class='ciw-vim' />


---
class: middle, has-code, zoom-code

### Auto-generating class name fragments in sass and JSX found to be bad. As is overriding styles.

```JSX
<div className={
  "Foo Foo__" + (this.props.active ? 'active' : 'inactive')
}>
  Hello!
</div>

```

```SASS
.Foo
  font-size: 15px
  color: red
  &__active
    color: blue
```

---

class: middle


## Why's this a bad idea?

1. Can't grep for `Foo__active` if you see it in the DOM

2. `Foo__active` overrides the color on `Foo`. Overrides beget overrides beget overrides

---

class: middle, has-code

### Better (also easier with React `classnames` module):

```CoffeeScript
classNames = require 'classnames' # a node module

...

render: ->
  classes = classNames "Foo",
    Foo__active: @props.active,
    Foo__inactive: !@props.active

  <div className={ classes }>
    Hello!
  </div>
```

```SASS
.Foo
  font-size: 15px
.Foo__inactive
  color: red
.Foo__active
  color: blue
```

---

class: middle, center, brown

# 4. Build

---

class: middle
## Main tools on dev:

- `grunt`
- `gulp`
- `webpack`
- `parallel-transpile`
- `mehserve`

---

class: middle

### `grunt`

- Runs tasks such as compiling and copying files


### `grunt-concurrent`

- Runs grunt tasks in parallel on multiple threads. Specifically:
  - stylus (legacy CSS pre-processor)
  - handlebars (legacy templates)
  - copy


---

class: middle
### `gulp`
- Watches for changes in sass files and compiles (gulp sass)
- Manually can lint sass files on change (gulp-scss-lint)


### `webpack`

- Bundles assets for the browser
- Uglifies in production
- Hot loader in development!


---

class: middle
timecounts `mehserve` ([github](https://github.com/timecounts/mehserve))
- Like pow.cx, but supports websockets!
- Uses `Host` header to proxy port 80 requests to named services
- Trivial to configure  
  `mehserve myservice 1337 && open http://myservice.meh/`
- Can serve static assets too  
  `mehserve whatever $(pwd) && open http://whatever.meh/`
- Also supports `.dev` domains
- Still under development (ugly errors, OSX instructions only)
---
class: middle

### It works like this:


<img src="images/meh.png" class="servers" />

---

class: middle
### timecounts `parallel-transpile` ([github](https://github.com/timecounts/parallel-transpile))
- uses all CPU cores to transpile source files quickly
- supports many webpack loaders and loader-chains  
  e.g. cjsx → coffee → jsx → js
- incremental updates (using file modification timestamps)
- used with webpack can speed up build times significantly
- suitable for one-to-one transpiles only
- experimental source map support (JS only)

---
class: middle, has-code
### `react-hot-loader`
 - Auto-updates components whilst keeping state
 etc. Awesome!!!

<img src="images/hotloader.gif" class="hotloader" />

---
class: middle

### It all works something like this:


<img src="images/servers.png" class="servers" />


---


class: middle, center, brown


# 5. A tiny bit on testing


---
class: middle

# Linting


- More maintainable code
- Helps prevent cruft accumulating
- Catches bugs
- Sets coding styles: easier to work with a team
- Shrinks compiled code size

---

class: middle, has-code

## E.g sass linting
We use very strict rules

<img src='images/sass-lint-file.png' title='file to lint' class='sass-lint-file' />

<img src='images/sass-lint.png' title='linter output' class='sass-lint' />



---
class: middle, has-code

## E.g. CoffeeScript linting

<img src='images/coffee-lint.png' title='coffee lint' class='coffee-lint' />

---
class: middle, has-code
## Acceptance tests (selenium)

- Automated testing in the browser
- Simulates clicks, scrolls etc
- Scripted using e.g. CoffeeScript

```CoffeeScript
yt 'homepage', ->
  yield @start("http://#{@browser.rootHost}/")
  aboutDisplayed = yield @browser.elementByCss("._qa_footerAbout").isDisplayed()
  aboutDisplayed.should.be.true
  formDisplayed = yield @browser.elementByCss("._qa_mc-embedded-subscribe-form input[name='EMAIL']").isDisplayed()
  formDisplayed.should.be.true
  yield @browser.elementByCss("._qa_homeLogin").click()
  yield @browser.waitFor(wd.asserters.loaded)
  url = yield @browser.url()
  url.should.equal("http://#{@browser.rootHost}/login")
```
---

### E.g. looks like this in practice:

<img src='images/selenium.gif' title='selenium webdriver' class='selenium' />

.aside[
Gif source: [Good Eggs](http://bites.goodeggs.com/posts/selenium-webdriver-nodejs-tutorial/)
]

---

class: middle
## Heroku "Review Apps"
Auto-deploys pull requests; great for reviewing by devs and non-dev team members alike.

<img src='images/heroku-review-apps.png' title='Heroku Review Apps' class='heroku-review-apps' />

---

class: middle, center
## Merge pull request and then:


---
class: middle, center, brown

# Ship it!

<img src='images/ship-it.jpg' title='Ship It Squirrel!' class='ship-it' />

(But that's another talk entirely...)

---
class: sweating, full-screen-gif


## Whew! That was a lot!
## Any questions?


---

class: middle, center, blue

## Thanks for being a great audience

### @jofarnold, @benjie

### We're hiring: [timecounts.org/jobs](https://timecounts.org/jobs)


---

Useful links:

- [BEM resources](https://github.com/sturobson/BEM-resources)
- [Heroku Review Apps](https://blog.heroku.com/archives/2015/5/19/heroku_review_apps_beta)
- [Timecounts `mehserve`](https://github.com/timecounts/mehserve)
- [Timecounts `parallel-transpile`](https://github.com/timecounts/parallel-transpile)
- [Selenium webdriver tutoriral](http://bites.goodeggs.com/posts/selenium-webdriver-nodejs-tutorial/)


--></script>
    <script src="remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create({
        source: (document.getElementById("source").innerHTML).replace(/^<!--|-->$/g, ""),
        slideNumberFormat: function (current, total) { return null },
        ratio: '4:3'
      });
    </script>
  </body>
</html>
